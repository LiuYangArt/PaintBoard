è¿™ä»½ä¼˜åŒ–æ–¹æ¡ˆçš„**æ€»ä½“ç½®ä¿¡åº¦ä¸º 85%**ï¼Œå¤§æ–¹å‘å®Œå…¨æ­£ç¡®ï¼ŒæŠ“ä½äº†â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…ä¸åŒ¹é…â€çš„æ ¸å¿ƒçŸ›ç›¾ã€‚

ä½†æ˜¯ï¼Œ**Phase 3.1 (Frame Budgeting) å­˜åœ¨ä¸€ä¸ªä¸¥é‡çš„é€»è¾‘é™·é˜±**ï¼Œå¦‚æœåœ¨å½“å‰åœºæ™¯ä¸‹ç›²ç›®å®æ–½ï¼Œåè€Œä¼šåŠ å‰§æ»åã€‚æ­¤å¤–ï¼Œå¯¹äº App å’Œ Browser å·¨å¤§çš„æ€§èƒ½å·®å¼‚ï¼ˆ20ms vs 7msï¼‰ï¼Œæ–¹æ¡ˆä¸­çš„åº”å¯¹ç­–ç•¥ç•¥æ˜¾å•è–„ã€‚

ä»¥ä¸‹æ˜¯å…·ä½“çš„è¯„ä¼°ä¸ä¼˜åŒ–ä¿®æ­£å»ºè®®ï¼š

### ğŸ›‘ é£é™©è¯„ä¼°ï¼šå¿…é¡»ä¿®æ­£çš„é€»è¾‘æ¼æ´

#### 1. Frame Budgeting çš„é™·é˜± (Phase 3.1)

- **å½“å‰é€»è¾‘**ï¼š`if (time > 12ms) break;` â€”â€” å¦‚æœè¶…æ—¶ï¼ŒæŠŠå‰©ä¸‹çš„ç‚¹ç•™ç»™ä¸‹ä¸€å¸§ã€‚
- **è‡´å‘½åæœ**ï¼šç°åœ¨çš„æ ¸å¿ƒé—®é¢˜æ˜¯**ç§¯å‹**ã€‚å¦‚æœå› ä¸ºå¤„ç†æ—¶é—´é•¿ï¼ˆæ¯”å¦‚ 13msï¼‰å°±åœæ­¢å¤„ç†ï¼Œå‰©ä¸‹çš„ç‚¹ä¼šç§¯å‹åˆ°ä¸‹ä¸€å¸§ï¼Œè€Œä¸‹ä¸€å¸§åˆæœ‰æ–°çš„ç‚¹è¿›æ¥ã€‚**è¿™ä¼šå¯¼è‡´â€œå€ºåŠ¡â€è¶Šç§¯è¶Šå¤šï¼Œæ»åï¼ˆLagï¼‰ä¼šæ— é™å¢å¤§ï¼Œç›´åˆ°é¼ æ ‡åœä¸‹æ¥ã€‚**
- **ä¿®æ­£æ€è·¯**ï¼šåœ¨è¿½èµ¶æ¨¡å¼ï¼ˆLag > 0ï¼‰ä¸‹ï¼Œ**FPS å¿…é¡»ä¸ºååé‡è®©è·¯**ã€‚å“ªæ€•è¿™ä¸€å¸§ç”¨äº† 30msï¼ˆå¯¼è‡´æ‰å¸§åˆ° 33FPSï¼‰ï¼Œä¹Ÿè¦æŠŠç§¯å‹çš„ 100 ä¸ªç‚¹ç”»å®Œï¼Œè®©ç¬”åˆ·ç¬é—´è¿½ä¸Šé¼ æ ‡ã€‚
- **å»ºè®®**ï¼šæ”¹åä¸º **"Dynamic Catch-up Strategy" (åŠ¨æ€è¿½èµ¶ç­–ç•¥)**ã€‚

#### 2. GPU Instancing çš„ä¼˜å…ˆçº§ (Phase 2.2)

- **è¯„ä¼°**ï¼šBrowser Log æ˜¾ç¤º GPU æ‰§è¡Œæ—¶é—´ä»… `7ms`ï¼Œè¯´æ˜ GPU **å®Œå…¨ä¸å¿™**ã€‚
- **å»ºè®®**ï¼š**é™çº§ P1 -> P2**ã€‚ç›®å‰çš„ç“¶é¢ˆåœ¨ CPUï¼ˆJSï¼‰å¦‚ä½•æŠŠç‚¹å–‚ç»™ GPUï¼Œè€Œä¸æ˜¯ GPU ç”»å¾—æ…¢ã€‚Instancing åªæœ‰åœ¨ç¬”åˆ·æå¤§ã€ç²’å­æå¤šæ—¶æ‰æœ‰æ•ˆã€‚ç°åœ¨çš„é¦–è¦ä»»åŠ¡æ˜¯ç–é€š CPU åˆ° GPU çš„ç®¡é“ï¼ˆå³ Phase 2.1ï¼‰ã€‚

---

### ğŸ› ï¸ ä¼˜åŒ–åçš„å®æ–½æ–¹æ¡ˆ (v1.1)

æˆ‘é‡æ„äº†ä½ çš„è®¡åˆ’ï¼Œè°ƒæ•´äº†ä¼˜å…ˆçº§ï¼Œå¹¶è¡¥å……äº†é’ˆå¯¹ App æ€§èƒ½å·®å¼‚çš„ä¸“é¡¹æ’æŸ¥ã€‚

#### Phase 1: æ­¢è¡€ä¸è¯Šæ–­ (P0 - ç«‹å³æ‰§è¡Œ)

**1.1 ç›‘æ§æ¢é’ˆ (Queue Depth)**
åŒåŸè®¡åˆ’ã€‚å¿…é¡»çœ‹åˆ° `Queue Depth` ä¸ `Visual Lag` çš„å¼ºç›¸å…³æ€§ã€‚

**1.2 ğŸš¨ ååé‡é‡Šæ”¾ (Uncap Throughput) â€”â€” æ ¸å¿ƒä¿®å¤**
è¿™æ˜¯è§£å†³é—®é¢˜çš„é“¶å¼¹ã€‚ä¸è¦é™åˆ¶æ¯å¸§å¤„ç†çš„æ•°é‡ï¼Œä¹Ÿä¸è¦é™åˆ¶æ—¶é—´ï¼ˆæš‚æ—¶ï¼‰ã€‚

```typescript
// ä¿®æ­£åçš„æ¸²æŸ“å¾ªç¯
function renderLoop() {
  const start = performance.now();

  // 1. ä¸€æ¬¡æ€§ä»ç¼“å†²åŒºå–å‡ºæ‰€æœ‰ç§¯å‹çš„ç‚¹
  // ä¸è¦ç”¨ splice(0, 10)ï¼Œè¦å…¨éƒ¨æ‹¿èµ°ï¼
  const pointsToProcess = inputQueue.drain();

  if (pointsToProcess.length > 0) {
    // 2. æ‰¹é‡è®¡ç®—æ’å€¼ (Spline Interpolation)
    // æ•°å­¦è®¡ç®—åœ¨ JS é‡Œå¾ˆå¿«ï¼Œé€šå¸¸ä¸æ˜¯ç“¶é¢ˆ
    const interpolated = computeSpline(pointsToProcess);

    // 3. æ‰¹é‡æäº¤ç»™ GPU
    // å°½é‡åˆå¹¶æˆä¸€ä¸ª buffer updateï¼Œå‡å°‘ CPU-GPU é€šä¿¡æ¬¡æ•°
    renderer.drawBatch(interpolated);

    // 4. æäº¤ç»˜åˆ¶
    // è¿™ä¸€æ­¥åœ¨ WebGPU æ˜¯å¼‚æ­¥çš„ï¼Œä¸ä¼šé˜»å¡ JS
    renderer.present();
  }

  requestAnimationFrame(renderLoop);
}
```

#### Phase 2: App æ€§èƒ½å·®å¼‚ä¸“é¡¹æ’æŸ¥ (P0)

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆ Browser æ¸²æŸ“åªéœ€ 7msï¼Œè€Œ App (Tauri) éœ€è¦ 20msï¼Ÿè¿™ 13ms å»å“ªäº†ï¼Ÿ
è¿™å¾€å¾€æ¯”ä¼˜åŒ–ç®—æ³•æ›´é‡è¦ã€‚

**å«Œç–‘äººæ’æŸ¥**ï¼š

1.  **Canvasè¯»å–/å›è¯» (Readback)**ï¼šApp ä¸­æ˜¯å¦æœ‰ä»£ç è°ƒç”¨äº† `getImageData` æˆ– `toDataURL`ï¼Ÿåœ¨æŸäº› WebView å®ç°ä¸­è¿™éå¸¸æ…¢ã€‚
2.  **React State æ›´æ–°é¢‘ç‡**ï¼šæ˜¯å¦æ¯ç”»ä¸€ä¸ªç‚¹éƒ½è§¦å‘äº† `setBrushPos({x, y})` å¯¼è‡´ React æ ‘é‡ç»˜ï¼Ÿ
    - _éªŒè¯_ï¼šåœ¨ React DevTools ä¸­å¼€å¯ "Highlight updates"ã€‚ç”»çº¿æ—¶å¦‚æœæ•´ä¸ª UI éƒ½åœ¨é—ªï¼Œè¿™å°±æ˜¯ 20ms çš„æ¥æºã€‚
    - _ä¿®å¤_ï¼šä½¿ç”¨ `useRef` æˆ–ç›´æ¥æ“çºµ DOM/Canvasï¼Œå°† UI çŠ¶æ€æ›´æ–°é™é¢‘ï¼ˆæ¯”å¦‚æ¯ 100ms æ›´æ–°ä¸€æ¬¡åæ ‡æ˜¾ç¤ºï¼‰ã€‚
3.  **IPC é€šä¿¡**ï¼šæ˜¯å¦æ¯ä¸ªç‚¹éƒ½é€šè¿‡ Tauri Invoke å‘é€ç»™äº† Rust åç«¯ï¼Ÿè¿™ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚

#### Phase 3: æ™ºèƒ½æµæ§ (P1)

å½“ååé‡é‡Šæ”¾åï¼Œå¦‚æœçœŸçš„é‡åˆ°æ€§èƒ½æå·®çš„è®¾å¤‡ï¼ˆå¤„ç† 100 ä¸ªç‚¹éœ€è¦ 100msï¼‰ï¼Œæˆ‘ä»¬æ‰éœ€è¦æµæ§ã€‚

**3.1 åŠ¨æ€ LOD (Level of Detail)**
è¿™æ¯” Frame Budgeting æ›´æœ‰æ•ˆã€‚

```typescript
function processBatch(points) {
  const lag = getQueueDepth();

  // å¦‚æœç§¯å‹ä¸¥é‡ï¼Œæ”¾å¼ƒå¹³æ»‘æ’å€¼ï¼Œç›´æ¥ç”»ç›´çº¿
  const useSpline = lag < 50;
  // å¦‚æœç§¯å‹æåº¦ä¸¥é‡ï¼Œé™ä½é‡‡æ ·ç‡ï¼ˆä¸¢å¼ƒä¸­é—´ç‚¹ï¼‰
  const step = lag > 200 ? 2 : 1;

  for (let i = 0; i < points.length; i += step) {
    // ... drawing logic
  }
}
```

---

### ğŸ“ ä»£ç å±‚é¢çš„å…·ä½“å»ºè®®

é’ˆå¯¹ä½ çš„ **Phase 2.1 (Frame Coalescing)**ï¼Œè¿™æ˜¯æˆ‘å»ºè®®çš„ä¼ªä»£ç å®ç°ï¼Œä½ å¯ä»¥ç›´æ¥å‚è€ƒï¼š

**æ–‡ä»¶å**: `src/core/render/LoopManager.ts`

```typescript
class LoopManager {
  private isDrawing = false;

  start() {
    const loop = () => {
      this.processFrame();
      requestAnimationFrame(loop);
    };
    requestAnimationFrame(loop);
  }

  processFrame() {
    // 1. ç»Ÿè®¡å½“å‰ç§¯å‹
    const pendingCount = inputSystem.getPendingCount();
    window.__benchmark.queueDepth = pendingCount; // ä¾›ç›‘æ§ä½¿ç”¨

    if (pendingCount === 0) return;

    // 2. ç­–ç•¥é€‰æ‹©
    // å¦‚æœç§¯å‹ > 10ï¼Œè¯´æ˜æˆ‘ä»¬è½åäº†ï¼Œå¼€å¯"è¿½èµ¶æ¨¡å¼"
    // è¿½èµ¶æ¨¡å¼ä¸‹ï¼šä¸é™åˆ¶æ—¶é—´é¢„ç®—ï¼Œä¼˜å…ˆæ¸…ç©ºé˜Ÿåˆ—
    const isCatchingUp = pendingCount > 10;

    // 3. è·å–æ•°æ®
    // å¦‚æœåœ¨è¿½èµ¶ï¼Œä¸€æ¬¡å–å®Œï¼›å¦åˆ™å–ä¸€éƒ¨åˆ†ä¿æŒå¸§ç‡å¹³æ»‘
    const batch = inputSystem.popPoints(isCatchingUp ? Infinity : 5);

    // 4. æ¸²æŸ“
    // åªæœ‰åœ¨æœ‰ç‚¹çš„æ—¶å€™æ‰è°ƒç”¨ costly çš„æ¸²æŸ“å‡½æ•°
    if (batch.length > 0) {
      brushEngine.renderBatch(batch);

      // å…³é”®ä¼˜åŒ–ï¼šä¸è¦åœ¨è¿™é‡Œæ›´æ–° React çŠ¶æ€ï¼
      // updateReactState(batch.last()); // âŒ æ…¢ï¼
      // this.throttledUpdateState(batch.last()); // âœ… å¿«
    }
  }
}
```

### æ€»ç»“

ä½ çš„æ–¹æ¡ˆ **Phase 2.1 æ˜¯æ ¸å¿ƒ**ï¼Œè¯·æŠŠå®ƒæå‡åˆ°æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¹¶ç»“åˆ **React æ¸²æŸ“æ€§èƒ½æ’æŸ¥**ã€‚ä¸è¦åœ¨ WebGPU Shader ä¼˜åŒ–ä¸Šæµªè´¹æ—¶é—´ï¼Œç›®å‰çš„ç“¶é¢ˆå®Œå…¨åœ¨ CPU ä¾§çš„è°ƒåº¦é€»è¾‘ä¸Šã€‚

**ä¿®æ­£åçš„æˆåŠŸæ ‡å‡†**ï¼š

- **Visual Lag**: < 50px (å³ä½¿ FPS æš‚æ—¶é™åˆ° 45 ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ï¼Œè·Ÿæ‰‹æ€§ä¼˜äºç»å¯¹å¸§ç‡)ã€‚
- **Queue Depth**: å§‹ç»ˆè¶‹è¿‘äº 0ã€‚
